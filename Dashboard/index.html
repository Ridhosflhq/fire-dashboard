<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WebGIS Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
    }
    #map {
      width: 40%;
      height: 100vh;
    }
    #dashboard {
      width: 60%;
      padding: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .card {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .card h3 {
      margin: 5px 0;
    }
    .chart-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .chart-container {
      flex: 1;
      min-height: 200px;
    }
    .table-container {
      flex: 1;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 12px;
    }
    table th {
      background: #f2f2f2;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="dashboard">
    <div class="card">
      <h3>Titik Api Hari Ini</h3>
      <p id="todayHotspot">0</p>
    </div>
    <div class="card">
      <h3>Titik Api Bulan Ini</h3>
      <p id="monthHotspot">0</p>
    </div>

    <div class="chart-row">
      <div class="chart-container card">
        <h3>Titik Api per Desa</h3>
        <canvas id="desaChart"></canvas>
      </div>
      <div class="chart-container card">
        <h3>Akumulasi Titik Api</h3>
        <canvas id="blokChart"></canvas>
      </div>
    </div>

    <div class="chart-row">
      <div class="chart-container card">
        <h3>Hotspot per Waktu (Bulanan)</h3>
        <canvas id="timeChart"></canvas>
      </div>
    </div>

    <div class="table-container card">
      <h3>Data Penggarap Lahan</h3>
      <table>
        <thead>
          <tr>
            <th>Lat</th><th>Lon</th><th>Date</th><th>Owner</th>
            <th>LC</th><th>Village</th><th>Blok</th>
          </tr>
        </thead>
        <tbody id="dataTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSgZRjQlxUsTPmrXiDCtwky4_A0FJrGDj_r7JLgsqi8gvjOWxmDKpBSdJDWFF38VfRuxUxzWSjhk46C/pub?gid=0&single=true&output=csv";

    const map = L.map('map').setView([0.8, 110.3], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);

    let desaChart, blokChart, timeChart;

    function updateChart(chart, id, labels, data, color) {
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById(id), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{ data: data, backgroundColor: color }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
      return chart;
    }

    function updateLineChart(chart, id, labels, data) {
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById(id), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{ data: data, borderColor: 'blue', fill: false }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
      return chart;
    }

    async function loadData() {
      const res = await fetch(sheetURL);
      const csv = await res.text();
      const rows = csv.split("\n").map(r => r.split(","));
      const headers = rows[0];
      const data = rows.slice(1).map(r => {
        let obj = {};
        headers.forEach((h,i) => obj[h.trim()] = r[i]);
        return obj;
      });
      updateDashboard(data);
    }

    function updateDashboard(data) {
      markersLayer.clearLayers();

      const today = new Date().toISOString().split("T")[0];
      const month = today.slice(0,7);

      document.getElementById("todayHotspot").innerText = data.filter(d => d.date && d.date.startsWith(today)).length;
      document.getElementById("monthHotspot").innerText = data.filter(d => d.date && d.date.startsWith(month)).length;

      data.forEach(d => {
        if (!d.latitude || !d.longitude) return;
        L.circleMarker([+d.latitude, +d.longitude], {radius: 5, color:"red"}).bindPopup(
          `Owner: ${d.owner}<br>Desa: ${d.village}<br>Blok: ${d.Blok}<br>Date: ${d.date}`
        ).addTo(markersLayer);
      });

      const desaCount = {};
      data.forEach(d => { if(d.village) desaCount[d.village] = (desaCount[d.village]||0)+1 });
      desaChart = updateChart(desaChart, "desaChart", Object.keys(desaCount), Object.values(desaCount), "orange");

      const blokCount = {};
      data.forEach(d => {
        if (d.date && d.Blok) {
          let key = d.date.slice(0,7) + " - " + d.Blok;
          blokCount[key] = (blokCount[key]||0)+1;
        }
      });
      blokChart = updateChart(blokChart, "blokChart", Object.keys(blokCount), Object.values(blokCount), "green");

      const timeCount = {};
      data.forEach(d => {
        if (d.date) {
          let key = d.date.slice(0,7); // YYYY-MM
          timeCount[key] = (timeCount[key] || 0) + 1;
        }
      });
      timeChart = updateLineChart(timeChart, "timeChart", Object.keys(timeCount), Object.values(timeCount));

      const tbody = document.getElementById("dataTable");
      tbody.innerHTML = "";
      data.forEach(d => {
        tbody.innerHTML += `<tr>
          <td>${d.latitude||""}</td><td>${d.longitude||""}</td>
          <td>${d.date||""}</td><td>${d.owner||""}</td>
          <td>${d.LC||""}</td><td>${d.village||""}</td><td>${d.Blok||""}</td>
        </tr>`;
      });
    }

    loadData();
  </script>
</body>
</html>
