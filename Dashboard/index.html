<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hotspot Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #map { height: 400px; }
    .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
    .card { background: #f8f8f8; padding: 15px; border-radius: 8px; text-align: center; }
    canvas { background: #fff; padding: 10px; border-radius: 8px; }
    #table-container { padding: 10px; }
  </style>
</head>
<body>

<h2 style="text-align:center">Hotspot Dashboard</h2>
<div id="map"></div>

<div class="dashboard">
  <div class="card">
    <h3>Today’s Hotspot</h3>
    <p id="todayCount">0</p>
  </div>
  <div class="card">
    <h3>Monthly Hotspot</h3>
    <p id="monthCount">0</p>
  </div>
  <div class="card">
    <h3>Total Records</h3>
    <p id="totalCount">0</p>
  </div>
</div>

<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:10px;">
  <canvas id="desaChart"></canvas>
  <canvas id="blokChart"></canvas>
</div>

<div id="table-container">
  <h3>Data Penggarap Lahan</h3>
  <table id="dataTable" class="display" style="width:100%">
    <thead>
      <tr>
        <th>Latitude</th>
        <th>Longitude</th>
        <th>Date</th>
        <th>Owner</th>
        <th>Village</th>
        <th>LC23</th>
        <th>Blok</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ403sZK2ewFnVV11IPe-z-DXvTcyNFmVdtpxNRFfoCac2dOcwIvsy3yRiA2-2hK0aE-jdsvJpSwEzG/pub?output=csv";

let map = L.map('map').setView([0.85, 110.33], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap'
}).addTo(map);

Papa.parse(csvUrl, {
  download: true,
  header: true,
  complete: function(results) {
    let data = results.data;
    let today = new Date().toISOString().slice(0,10);
    let currentMonth = today.slice(0,7);

    let todayCount = 0, monthCount = 0;
    let desaCount = {}, blokCount = {};
    let tableData = [];

    data.forEach(row => {
      if (!row.latitude || !row.longitude) return;
      let lat = parseFloat(row.latitude), lon = parseFloat(row.longitude);
      let date = row.acq_date;
      let desa = row.nama_kel;
      let blok = row.Blok;
      let owner = row.Owner;
      let lc = row.LC23;

      L.circleMarker([lat, lon], { radius: 5, color: "red" })
        .bindPopup(`<b>${desa}</b><br>Owner: ${owner}<br>Date: ${date}`)
        .addTo(map);

      if (date === today) todayCount++;
      if (date.startsWith(currentMonth)) monthCount++;

      desaCount[desa] = (desaCount[desa] || 0) + 1;
      let monthKey = date.slice(0,7) + " - " + blok;
      blokCount[monthKey] = (blokCount[monthKey] || 0) + 1;

      tableData.push([lat, lon, date, owner, desa, lc, blok]);
    });

    document.getElementById("todayCount").innerText = todayCount;
    document.getElementById("monthCount").innerText = monthCount;
    document.getElementById("totalCount").innerText = data.length;

    new Chart(document.getElementById("desaChart"), {
      type: 'bar',
      data: {
        labels: Object.keys(desaCount),
        datasets: [{ label: "Hotspot per Desa", data: Object.values(desaCount), backgroundColor: "orange" }]
      }
    });

    new Chart(document.getElementById("blokChart"), {
      type: 'bar',
      data: {
        labels: Object.keys(blokCount),
        datasets: [{ label: "Akumulasi per Blok", data: Object.values(blokCount), backgroundColor: "green" }]
      }
    });

    $('#dataTable').DataTable({ data: tableData });
  }
});
</script>
</body>
</html>
